generator client {
  provider        = "prisma-client-js"
  output          = "../generated/client"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
}

model AdminUser {
  id                      String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username                String                @unique @db.VarChar(100)
  email                   String?               @unique @db.VarChar(255)
  passwordHash            String                @map("password_hash") @db.VarChar(255)
  displayName             String                @map("display_name") @db.VarChar(200)
  fullName                String?               @map("full_name") @db.VarChar(200)
  role                    String                @db.VarChar(20)
  lastLogin               DateTime?             @map("last_login") @db.Timestamp(6)
  createdAt               DateTime?             @default(now()) @map("created_at") @db.Timestamp(6)
  first_name              String?               @db.VarChar(100)
  last_name               String?               @db.VarChar(100)
  updated_at              DateTime?             @default(now()) @db.Timestamp(6)
  disabled                Boolean               @default(false)
  disabledAt              DateTime?             @map("disabled_at") @db.Timestamp(6)
  disabledBy              String?               @map("disabled_by") @db.Uuid
  updatedBy               String?               @map("updated_by") @db.Uuid
  auditLogs               AuditLog[]
  checkins                Checkin[]
  report_audit_log        report_audit_log[]
  ddsAssignments          DdsAssignment[]
  disabledByAdmin         AdminUser?            @relation("DisabledBy", fields: [disabledBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedByAdmin          AdminUser?            @relation("UpdatedBy", fields: [updatedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  disabledUsers           AdminUser[]           @relation("DisabledBy")
  updatedUsers            AdminUser[]           @relation("UpdatedBy")
  qualificationsGranted   MemberQualification[] @relation("QualificationGrantedBy")
  qualificationsRevoked   MemberQualification[] @relation("QualificationRevokedBy")
  schedulesCreated        WeeklySchedule[]      @relation("ScheduleCreatedBy")
  schedulesPublished      WeeklySchedule[]      @relation("SchedulePublishedBy")
  missedCheckoutsResolved MissedCheckout[]

  @@index([email], map: "idx_admin_users_email")
  @@index([disabled], map: "idx_admin_users_disabled")
  @@map("admin_users")
}

model AuditLog {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminUserId String?    @map("admin_user_id") @db.Uuid
  action      String     @db.VarChar(100)
  entityType  String     @map("entity_type") @db.VarChar(50)
  entityId    String?    @map("entity_id") @db.Uuid
  details     Json?
  ipAddress   String?    @map("ip_address") @db.Inet
  createdAt   DateTime?  @default(now()) @map("created_at") @db.Timestamp(6)
  adminUser   AdminUser? @relation(fields: [adminUserId], references: [id], onUpdate: NoAction)

  @@index([adminUserId, createdAt(sort: Desc)], map: "idx_audit_log_admin_created")
  @@index([createdAt(sort: Desc)], map: "idx_audit_log_created")
  @@index([entityType, entityId], map: "idx_audit_log_entity")
  @@map("audit_log")
}

model Badge {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serialNumber   String          @unique @map("serial_number") @db.VarChar(100)
  assignmentType String          @map("assignment_type") @db.VarChar(20)
  assignedToId   String?         @map("assigned_to_id") @db.Uuid
  status         String          @default("active") @db.VarChar(20)
  badgeStatusId  String?         @map("badge_status_id") @db.Uuid
  lastUsed       DateTime?       @map("last_used") @db.Timestamp(6)
  createdAt      DateTime?       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime?       @default(now()) @map("updated_at") @db.Timestamp(6)
  checkins       Checkin[]
  eventAttendees EventAttendee[]
  eventCheckins  EventCheckin[]
  members        Member[]
  visitors       Visitor[]
  badgeStatusRef BadgeStatus?    @relation(fields: [badgeStatusId], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@index([assignedToId], map: "idx_badges_assigned_to")
  @@index([serialNumber], map: "idx_badges_serial_number")
  @@index([status], map: "idx_badges_status")
  @@index([assignmentType], map: "idx_badges_assignment_type")
  @@index([badgeStatusId], map: "idx_badges_badge_status_id")
  @@map("badges")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Checkin {
  id                 String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId           String?    @map("member_id") @db.Uuid
  badgeId            String?    @map("badge_id") @db.Uuid
  direction          String     @db.VarChar(10)
  timestamp          DateTime   @default(now()) @db.Timestamp(6)
  kioskId            String     @map("kiosk_id") @db.VarChar(50)
  synced             Boolean?   @default(true)
  createdAt          DateTime?  @default(now()) @map("created_at") @db.Timestamp(6)
  flagged_for_review Boolean?   @default(false)
  flag_reason        String?    @db.VarChar(255)
  method             String?    @default("badge") @db.VarChar(20)
  created_by_admin   String?    @db.Uuid
  badge              Badge?     @relation(fields: [badgeId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  admin_users        AdminUser? @relation(fields: [created_by_admin], references: [id], onDelete: NoAction, onUpdate: NoAction)
  member             Member?    @relation(fields: [memberId], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@index([badgeId], map: "idx_checkins_badge")
  @@index([kioskId, timestamp(sort: Desc)], map: "idx_checkins_kiosk")
  @@index([memberId, timestamp(sort: Desc)], map: "idx_checkins_member_timestamp")
  @@index([timestamp(sort: Desc)], map: "idx_checkins_timestamp")
  @@index([method], map: "idx_checkins_method")
  @@map("checkins")
}

model Division {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String    @db.VarChar(100)
  code        String    @unique @db.VarChar(20)
  description String?
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)
  members     Member[]

  @@map("divisions")
}

model EventAttendee {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId         String         @map("event_id") @db.Uuid
  name            String         @db.VarChar(200)
  rank            String?        @db.VarChar(50)
  organization    String         @db.VarChar(200)
  role            String         @db.VarChar(100)
  badgeId         String?        @map("badge_id") @db.Uuid
  badgeAssignedAt DateTime?      @map("badge_assigned_at") @db.Timestamp(6)
  accessStart     DateTime?      @map("access_start") @db.Date
  accessEnd       DateTime?      @map("access_end") @db.Date
  status          String         @default("pending") @db.VarChar(20)
  createdAt       DateTime?      @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime?      @default(now()) @map("updated_at") @db.Timestamp(6)
  badge           Badge?         @relation(fields: [badgeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  event           Event          @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  eventCheckins   EventCheckin[]

  @@index([badgeId], map: "idx_event_attendees_badge_id")
  @@index([eventId], map: "idx_event_attendees_event_id")
  @@index([status], map: "idx_event_attendees_status")
  @@map("event_attendees")
}

model EventCheckin {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventAttendeeId String        @map("event_attendee_id") @db.Uuid
  badgeId         String        @map("badge_id") @db.Uuid
  direction       String        @db.VarChar(10)
  timestamp       DateTime      @default(now()) @db.Timestamp(6)
  kioskId         String        @map("kiosk_id") @db.VarChar(50)
  createdAt       DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  badge           Badge         @relation(fields: [badgeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  eventAttendee   EventAttendee @relation(fields: [eventAttendeeId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([eventAttendeeId, timestamp(sort: Desc)], map: "idx_event_checkins_attendee")
  @@index([badgeId], map: "idx_event_checkins_badge")
  @@index([kioskId, timestamp(sort: Desc)], map: "idx_event_checkins_kiosk")
  @@index([timestamp(sort: Desc)], map: "idx_event_checkins_timestamp")
  @@map("event_checkins")
}

model Event {
  id               String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String          @db.VarChar(200)
  code             String          @unique @db.VarChar(50)
  description      String?
  startDate        DateTime        @map("start_date") @db.Date
  endDate          DateTime        @map("end_date") @db.Date
  status           String          @default("draft") @db.VarChar(20)
  autoExpireBadges Boolean?        @default(true) @map("auto_expire_badges")
  customRoles      Json?           @map("custom_roles")
  createdBy        String?         @map("created_by") @db.Uuid
  createdAt        DateTime?       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime?       @default(now()) @map("updated_at") @db.Timestamp(6)
  eventAttendees   EventAttendee[]
  visitors         Visitor[]

  @@index([startDate, endDate], map: "idx_events_dates")
  @@index([status], map: "idx_events_status")
  @@map("events")
}

model Member {
  id                         String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serviceNumber              String                    @unique @map("service_number") @db.VarChar(20)
  rankId                     String                    @map("rank_id") @db.Uuid
  rank                       String                    @db.VarChar(50)
  firstName                  String                    @map("first_name") @db.VarChar(100)
  lastName                   String                    @map("last_name") @db.VarChar(100)
  displayName                String?                   @map("display_name") @db.VarChar(200)
  email                      String?                   @db.VarChar(255)
  mobilePhone                String?                   @map("mobile_phone") @db.VarChar(50)
  divisionId                 String?                   @map("division_id") @db.Uuid
  badgeId                    String?                   @map("badge_id") @db.Uuid
  memberType                 String                    @map("member_type") @db.VarChar(20)
  status                     String                    @default("active") @db.VarChar(20)
  memberTypeId               String?                   @map("member_type_id") @db.Uuid
  memberStatusId             String?                   @map("member_status_id") @db.Uuid
  createdAt                  DateTime?                 @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt                  DateTime?                 @default(now()) @map("updated_at") @db.Timestamp(6)
  employeeNumber             String?                   @map("employee_number") @db.VarChar(20)
  initials                   String?                   @db.VarChar(10)
  mess                       String?                   @db.VarChar(50)
  moc                        String?                   @db.VarChar(100)
  classDetails               String?                   @map("class_details") @db.VarChar(100)
  homePhone                  String?                   @map("home_phone") @db.VarChar(30)
  notes                      String?
  contract_start             DateTime?                 @db.Date
  contract_end               DateTime?                 @db.Date
  missedCheckoutCount        Int                       @default(0) @map("missed_checkout_count")
  lastMissedCheckout         DateTime?                 @map("last_missed_checkout") @db.Timestamp(6)
  rankRef                    Rank?                     @relation(fields: [rankId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  badge                      Badge?                    @relation(fields: [badgeId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  bmqEnrollments             BmqEnrollment[]
  checkins                   Checkin[]
  division                   Division?                 @relation(fields: [divisionId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  visitorsHosted             Visitor[]                 @relation("VisitorHost")
  visitorsCreated            Visitor[]                 @relation("VisitorCreatedBy")
  memberTags                 MemberTag[]
  ddsAssignments             DdsAssignment[]           @relation("DdsMember")
  ddsTransfers               DdsAssignment[]           @relation("DdsTransferredTo")
  memberTypeRef              MemberType?               @relation(fields: [memberTypeId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  memberStatusRef            MemberStatus?             @relation(fields: [memberStatusId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  qualifications             MemberQualification[]
  scheduleAssignments        ScheduleAssignment[]
  dwOverridesAsMember        DutyWatchNightOverride[]  @relation("OverrideMember")
  dwOverridesAsBase          DutyWatchNightOverride[]  @relation("OverrideBaseMember")
  lockupHolding              LockupStatus[]            @relation("LockupCurrentHolder")
  lockupSecured              LockupStatus[]            @relation("LockupSecuredBy")
  lockupTransfersFrom        LockupTransfer[]          @relation("LockupTransferFrom")
  lockupTransfersTo          LockupTransfer[]          @relation("LockupTransferTo")
  lockupExecutions           LockupExecution[]
  pinHash                    String?                   @map("pin_hash") @db.VarChar(255)
  accountLevel               Int                       @default(1) @map("account_level")
  missedCheckouts            MissedCheckout[]
  unitEventDutyAssignments   UnitEventDutyAssignment[]
  memberSessions             MemberSession[]
  acknowledgedSecurityAlerts SecurityAlert[]           @relation("AlertAcknowledgedBy")

  @@index([badgeId], map: "idx_members_badge")
  @@index([divisionId], map: "idx_members_division")
  @@index([employeeNumber], map: "idx_members_employee_number")
  @@index([mess], map: "idx_members_mess")
  @@index([moc], map: "idx_members_moc")
  @@index([rankId], map: "idx_members_rank_id")
  @@index([serviceNumber], map: "idx_members_service_number")
  @@index([status], map: "idx_members_status")
  @@index([email], map: "idx_members_email")
  @@index([memberTypeId], map: "idx_members_member_type_id")
  @@index([memberStatusId], map: "idx_members_member_status_id")
  @@map("members")
}

model MemberSession {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId  String   @map("member_id") @db.Uuid
  token     String   @unique @db.VarChar(128)
  expiresAt DateTime @map("expires_at") @db.Timestamp(6)
  ipAddress String?  @map("ip_address") @db.Inet
  userAgent String?  @map("user_agent") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamp(6)
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([memberId], map: "idx_member_sessions_member")
  @@index([expiresAt], map: "idx_member_sessions_expires")
  @@map("member_sessions")
}

model Tag {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String              @unique @db.VarChar(100)
  description        String?
  displayOrder       Int                 @default(0) @map("display_order")
  chipVariant        String              @default("solid") @map("chip_variant") @db.VarChar(20)
  chipColor          String              @default("default") @map("chip_color") @db.VarChar(20)
  isPositional       Boolean             @default(false) @map("is_positional")
  createdAt          DateTime?           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime?           @default(now()) @map("updated_at") @db.Timestamptz(6)
  memberTags         MemberTag[]
  qualificationTypes QualificationType[]

  @@index([name], map: "idx_tags_name")
  @@index([displayOrder], map: "idx_tags_display_order")
  @@map("tags")
}

model MemberTag {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId  String    @map("member_id") @db.Uuid
  tagId     String    @map("tag_id") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  member    Member    @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tag       Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([memberId, tagId], map: "idx_member_tags_member_tag")
  @@index([memberId], map: "idx_member_tags_member")
  @@index([tagId], map: "idx_member_tags_tag")
  @@map("member_tags")
}

model SecurityAlert {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  alertType       String    @map("alert_type") @db.VarChar(50) // badge_disabled, badge_unknown, inactive_member
  severity        String    @db.VarChar(20) // critical, warning, info
  badgeSerial     String?   @map("badge_serial") @db.VarChar(100)
  memberId        String?   @map("member_id") @db.Uuid
  kioskId         String    @map("kiosk_id") @db.VarChar(50)
  message         String
  details         Json? // Additional context (badge status, member info, etc.)
  status          String    @default("active") @db.VarChar(20) // active, acknowledged, dismissed
  acknowledgedBy  String?   @map("acknowledged_by") @db.Uuid
  acknowledgedAt  DateTime? @map("acknowledged_at") @db.Timestamp(6)
  acknowledgeNote String?   @map("acknowledge_note")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  acknowledgedByMember Member? @relation("AlertAcknowledgedBy", fields: [acknowledgedBy], references: [id], onUpdate: NoAction)

  @@index([status], map: "idx_security_alerts_status")
  @@index([alertType], map: "idx_security_alerts_type")
  @@index([severity], map: "idx_security_alerts_severity")
  @@index([createdAt(sort: Desc)], map: "idx_security_alerts_created")
  @@map("security_alerts")
}

model Visitor {
  id               String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String     @db.VarChar(200)
  rankPrefix       String?    @map("rank_prefix") @db.VarChar(50)
  firstName        String?    @map("first_name") @db.VarChar(100)
  lastName         String?    @map("last_name") @db.VarChar(100)
  displayName      String?    @map("display_name") @db.VarChar(200)
  organization     String?    @db.VarChar(200)
  visitType        String     @map("visit_type") @db.VarChar(50)
  visitTypeId      String?    @map("visit_type_id") @db.Uuid
  visitReason      String?    @map("visit_reason")
  eventId          String?    @map("event_id") @db.Uuid
  hostMemberId     String?    @map("host_member_id") @db.Uuid
  checkInTime      DateTime   @default(now()) @map("check_in_time") @db.Timestamp(6)
  checkOutTime     DateTime?  @map("check_out_time") @db.Timestamp(6)
  temporaryBadgeId String?    @map("temporary_badge_id") @db.Uuid
  kioskId          String     @map("kiosk_id") @db.VarChar(50)
  createdAt        DateTime?  @default(now()) @map("created_at") @db.Timestamp(6)
  adminNotes       String?    @map("admin_notes")
  checkInMethod    String?    @default("kiosk") @map("check_in_method") @db.VarChar(20)
  createdByAdmin   String?    @map("created_by_admin") @db.Uuid
  createdByMember  Member?    @relation("VisitorCreatedBy", fields: [createdByAdmin], references: [id], onDelete: SetNull, onUpdate: NoAction)
  event            Event?     @relation(fields: [eventId], references: [id], onUpdate: NoAction)
  hostMember       Member?    @relation("VisitorHost", fields: [hostMemberId], references: [id], onUpdate: NoAction)
  badge            Badge?     @relation(fields: [temporaryBadgeId], references: [id], onUpdate: NoAction)
  visitTypeRef     VisitType? @relation(fields: [visitTypeId], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@index([checkInTime(sort: Desc)], map: "idx_visitors_check_in_time")
  @@index([checkOutTime], map: "idx_visitors_check_out_time")
  @@index([eventId], map: "idx_visitors_event")
  @@index([hostMemberId], map: "idx_visitors_host")
  @@index([checkInMethod], map: "idx_visitors_check_in_method")
  @@index([temporaryBadgeId], map: "idx_visitors_temporary_badge")
  @@index([visitTypeId], map: "idx_visitors_visit_type_id")
  @@map("visitors")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model BmqCourse {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String          @db.VarChar(100)
  startDate         DateTime        @map("start_date") @db.Date
  endDate           DateTime        @map("end_date") @db.Date
  trainingStartTime DateTime        @map("training_start_time") @db.Time(6)
  trainingEndTime   DateTime        @map("training_end_time") @db.Time(6)
  isActive          Boolean         @default(true) @map("is_active")
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime        @default(now()) @map("updated_at") @db.Timestamptz(6)
  trainingDays      String[]        @map("training_days")
  bmqEnrollments    BmqEnrollment[]

  @@index([startDate, endDate], map: "idx_bmq_courses_dates")
  @@index([isActive], map: "idx_bmq_courses_is_active")
  @@map("bmq_courses")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model BmqEnrollment {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId    String    @map("member_id") @db.Uuid
  bmqCourseId String    @map("bmq_course_id") @db.Uuid
  enrolledAt  DateTime  @default(now()) @map("enrolled_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  status      String    @default("enrolled") @db.VarChar(20)
  bmqCourse   BmqCourse @relation(fields: [bmqCourseId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  member      Member    @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([memberId, bmqCourseId], map: "bmq_enrollments_member_id_bmq_course_id_key")
  @@index([bmqCourseId], map: "idx_bmq_enrollments_course")
  @@index([memberId], map: "idx_bmq_enrollments_member")
  @@index([status], map: "idx_bmq_enrollments_status")
  @@map("bmq_enrollments")
}

model migrations {
  id         Int       @id @default(autoincrement())
  name       String    @unique @db.VarChar(255)
  applied_at DateTime? @default(now()) @db.Timestamp(6)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model report_audit_log {
  id                  String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  report_type         String     @db.VarChar(50)
  report_config       Json
  generated_by        String?    @db.Uuid
  is_scheduled        Boolean?   @default(false)
  scheduled_report_id String?    @db.Uuid
  generated_at        DateTime?  @default(now()) @db.Timestamptz(6)
  file_size_bytes     Int?
  generation_time_ms  Int?
  admin_users         AdminUser? @relation(fields: [generated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([generated_at], map: "idx_report_audit_log_generated_at")
  @@index([generated_by], map: "idx_report_audit_log_generated_by")
  @@index([is_scheduled], map: "idx_report_audit_log_is_scheduled")
  @@index([report_type], map: "idx_report_audit_log_type")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model ReportSetting {
  key       String   @id @db.VarChar(100)
  value     Json
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@map("report_settings")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model TrainingYear {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String   @db.VarChar(50)
  startDate         DateTime @map("start_date") @db.Date
  endDate           DateTime @map("end_date") @db.Date
  holidayExclusions Json     @default("[]") @map("holiday_exclusions")
  dayExceptions     Json     @default("[]") @map("day_exceptions")
  isCurrent         Boolean  @default(false) @map("is_current")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@index([isCurrent], map: "idx_training_years_is_current")
  @@index([startDate], map: "idx_training_years_start_date")
  @@map("training_years")
}

model DdsAssignment {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId      String    @map("member_id") @db.Uuid
  assignedDate  DateTime  @map("assigned_date") @db.Date
  acceptedAt    DateTime? @map("accepted_at") @db.Timestamp(6)
  releasedAt    DateTime? @map("released_at") @db.Timestamp(6)
  transferredTo String?   @map("transferred_to") @db.Uuid
  assignedBy    String?   @map("assigned_by") @db.Uuid
  status        String    @default("pending") @db.VarChar(20) // pending, active, released, transferred
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime  @default(now()) @map("updated_at") @db.Timestamp(6)

  member              Member     @relation("DdsMember", fields: [memberId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  transferredToMember Member?    @relation("DdsTransferredTo", fields: [transferredTo], references: [id], onDelete: SetNull, onUpdate: NoAction)
  assignedByAdmin     AdminUser? @relation(fields: [assignedBy], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([memberId], map: "idx_dds_assignments_member")
  @@index([assignedDate], map: "idx_dds_assignments_date")
  @@index([status], map: "idx_dds_assignments_status")
  @@map("dds_assignments")
}

model ResponsibilityAuditLog {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId        String   @map("member_id") @db.Uuid
  tagName         String   @map("tag_name") @db.VarChar(50) // 'DDS' or 'Lockup'
  action          String   @db.VarChar(50) // assigned, transferred, released, self_accepted
  fromMemberId    String?  @map("from_member_id") @db.Uuid
  toMemberId      String?  @map("to_member_id") @db.Uuid
  performedBy     String?  @map("performed_by") @db.Uuid
  performedByType String   @map("performed_by_type") @db.VarChar(20) // 'admin' or 'member'
  timestamp       DateTime @default(now()) @db.Timestamp(6)
  notes           String?

  @@index([memberId], map: "idx_responsibility_audit_member")
  @@index([tagName], map: "idx_responsibility_audit_tag")
  @@index([timestamp(sort: Desc)], map: "idx_responsibility_audit_timestamp")
  @@map("responsibility_audit_log")
}

// ============================================================================
// ENUM TABLES - Lookup/reference tables for configurable enumerations
// ============================================================================

model MemberStatus {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String    @unique @db.VarChar(50)
  name        String    @db.VarChar(100)
  description String?
  chipVariant String    @default("solid") @map("chip_variant") @db.VarChar(20)
  chipColor   String    @default("default") @map("chip_color") @db.VarChar(20)
  isHidden    Boolean   @default(false) @map("is_hidden")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)
  members     Member[]

  @@index([code], map: "idx_member_statuses_code")
  @@index([name], map: "idx_member_statuses_name")
  @@map("member_statuses")
}

model MemberType {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String    @unique @db.VarChar(50)
  name        String    @db.VarChar(100)
  description String?
  chipVariant String    @default("solid") @map("chip_variant") @db.VarChar(20)
  chipColor   String    @default("default") @map("chip_color") @db.VarChar(20)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)
  members     Member[]

  @@index([code], map: "idx_member_types_code")
  @@index([name], map: "idx_member_types_name")
  @@map("member_types")
}

model VisitType {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String    @unique @db.VarChar(50)
  name        String    @db.VarChar(100)
  description String?
  chipVariant String    @default("solid") @map("chip_variant") @db.VarChar(20)
  chipColor   String    @default("default") @map("chip_color") @db.VarChar(20)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)
  visitors    Visitor[]

  @@index([code], map: "idx_visit_types_code")
  @@index([name], map: "idx_visit_types_name")
  @@map("visit_types")
}

model BadgeStatus {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String    @unique @db.VarChar(50)
  name        String    @db.VarChar(100)
  description String?
  chipVariant String    @default("solid") @map("chip_variant") @db.VarChar(20)
  chipColor   String    @default("default") @map("chip_color") @db.VarChar(20)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)
  badges      Badge[]

  @@index([code], map: "idx_badge_statuses_code")
  @@index([name], map: "idx_badge_statuses_name")
  @@map("badge_statuses")
}

model ListItem {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  listType     String    @map("list_type") @db.VarChar(50) // event_role, rank, mess, moc, etc.
  code         String    @db.VarChar(50)
  name         String    @db.VarChar(100)
  displayOrder Int       @default(0) @map("display_order")
  description  String?
  isSystem     Boolean   @default(false) @map("is_system")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  @@unique([listType, code], map: "list_items_list_type_code_unique")
  @@index([listType], map: "idx_list_items_list_type")
  @@index([listType, displayOrder], map: "idx_list_items_list_type_display_order")
  @@map("list_items")
}

// ============================================================================
// RANK TABLE - Canadian Armed Forces rank structure
// ============================================================================

model Rank {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String    @unique @db.VarChar(10)
  name         String    @db.VarChar(100)
  branch       String    @db.VarChar(20) // navy, army, air_force
  category     String    @db.VarChar(50) // junior_ncm, senior_ncm, junior_officer, senior_officer, general_officer
  displayOrder Int       @map("display_order") // 1-19 within branch (lower = junior, higher = senior)
  isActive     Boolean   @default(true) @map("is_active")
  replacedBy   String?   @map("replaced_by") @db.Uuid
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  members        Member[]
  replacedByRank Rank?    @relation("RankReplacement", fields: [replacedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replacesRanks  Rank[]   @relation("RankReplacement")

  @@index([branch, displayOrder], map: "idx_ranks_branch_order")
  @@index([code], map: "idx_ranks_code")
  @@index([isActive], map: "idx_ranks_active")
  @@map("ranks")
}

// ============================================================================
// Better-Auth Models
// ============================================================================

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String    @unique @db.VarChar(255)
  emailVerified Boolean   @default(false) @map("email_verified")
  name          String?   @db.VarChar(200)
  image         String?   @db.VarChar(500)
  role          String    @default("quartermaster") @db.VarChar(50)
  badgeId       String?   @unique @map("badge_id") @db.VarChar(100)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)
  sessions      Session[]
  accounts      Account[]
  // apiKeys relation removed - better-auth API Key plugin manages its own table

  @@index([email], map: "idx_users_email")
  @@index([badgeId], map: "idx_users_badge_id")
  @@map("user")
}

model Session {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at") @db.Timestamp(6)
  ipAddress String?  @map("ip_address") @db.Inet
  userAgent String?  @map("user_agent") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_sessions_user_id")
  @@index([expiresAt], map: "idx_sessions_expires_at")
  @@map("session")
}

model Account {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  accountId    String    @map("account_id") @db.VarChar(255)
  providerId   String    @map("provider_id") @db.VarChar(100)
  accessToken  String?   @map("access_token") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  idToken      String?   @map("id_token") @db.Text
  expiresAt    DateTime? @map("expires_at") @db.Timestamp(6)
  password     String?   @db.VarChar(255)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId], map: "account_provider_account_unique")
  @@index([userId], map: "idx_accounts_user_id")
  @@map("account")
}

model Verification {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identifier String   @db.VarChar(255)
  value      String   @db.VarChar(500)
  expiresAt  DateTime @map("expires_at") @db.Timestamp(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  @@unique([identifier, value], map: "verification_identifier_value_unique")
  @@index([expiresAt], map: "idx_verifications_expires_at")
  @@map("verification")
}

// ApiKey model removed - now using better-auth API Key plugin
// The plugin will create its own api_key table with proper schema

// ============================================================================
// Settings Table - Application configuration management
// ============================================================================

model Setting {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       Json
  category    String   @default("system") @db.VarChar(50)
  description String?  @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([key], map: "idx_settings_key")
  @@index([category], map: "idx_settings_category")
  @@map("settings")
}

model AlertConfig {
  key       String   @id @db.VarChar(100)
  config    Json
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamp(6)

  @@index([key], map: "idx_alert_configs_key")
  @@map("alert_configs")
}

// ============================================================================
// STATUTORY HOLIDAYS
// ============================================================================

model StatHoliday {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date      DateTime @unique @db.Date
  name      String   @db.VarChar(100)
  province  String?  @db.VarChar(20) // null = federal, otherwise province code (ON, BC, etc.)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([date], map: "idx_stat_holidays_date")
  @@index([isActive], map: "idx_stat_holidays_active")
  @@map("stat_holidays")
}

// ============================================================================
// DUTY ROLES & LOCKUP SYSTEM
// ============================================================================

model QualificationType {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                 String                @unique @db.VarChar(50)
  name                 String                @db.VarChar(100)
  description          String?
  canReceiveLockup     Boolean               @default(true) @map("can_receive_lockup")
  isAutomatic          Boolean               @default(false) @map("is_automatic")
  displayOrder         Int                   @default(0) @map("display_order")
  tagId                String?               @map("tag_id") @db.Uuid
  createdAt            DateTime              @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt            DateTime              @updatedAt @map("updated_at") @db.Timestamp(6)
  memberQualifications MemberQualification[]
  tag                  Tag?                  @relation(fields: [tagId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([code], map: "idx_qualification_types_code")
  @@index([canReceiveLockup], map: "idx_qualification_types_lockup")
  @@index([tagId], map: "idx_qualification_types_tag")
  @@map("qualification_types")
}

model MemberQualification {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId            String    @map("member_id") @db.Uuid
  qualificationTypeId String    @map("qualification_type_id") @db.Uuid
  status              String    @default("active") @db.VarChar(20) // active, expired, revoked
  grantedAt           DateTime  @default(now()) @map("granted_at") @db.Timestamp(6)
  grantedBy           String?   @map("granted_by") @db.Uuid
  expiresAt           DateTime? @map("expires_at") @db.Timestamp(6)
  revokedAt           DateTime? @map("revoked_at") @db.Timestamp(6)
  revokedBy           String?   @map("revoked_by") @db.Uuid
  revokeReason        String?   @map("revoke_reason")
  notes               String?
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  member            Member            @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  qualificationType QualificationType @relation(fields: [qualificationTypeId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  grantedByAdmin    AdminUser?        @relation("QualificationGrantedBy", fields: [grantedBy], references: [id], onDelete: SetNull, onUpdate: NoAction)
  revokedByAdmin    AdminUser?        @relation("QualificationRevokedBy", fields: [revokedBy], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@unique([memberId, qualificationTypeId], map: "member_qualification_unique")
  @@index([memberId], map: "idx_member_qualifications_member")
  @@index([qualificationTypeId], map: "idx_member_qualifications_type")
  @@index([status], map: "idx_member_qualifications_status")
  @@map("member_qualifications")
}

model DutyRole {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String           @unique @db.VarChar(50)
  name         String           @db.VarChar(100)
  description  String?
  roleType     String           @map("role_type") @db.VarChar(20) // single, team
  scheduleType String           @map("schedule_type") @db.VarChar(20) // weekly
  activeDays   Int[]            @map("active_days") // 1=Mon, 2=Tue, ..., 7=Sun
  displayOrder Int              @default(0) @map("display_order")
  createdAt    DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime         @updatedAt @map("updated_at") @db.Timestamp(6)
  positions    DutyPosition[]
  schedules    WeeklySchedule[]

  @@index([code], map: "idx_duty_roles_code")
  @@map("duty_roles")
}

model DutyPosition {
  id             String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  dutyRoleId     String                   @map("duty_role_id") @db.Uuid
  code           String                   @db.VarChar(50)
  name           String                   @db.VarChar(100)
  description    String?
  maxSlots       Int                      @default(1) @map("max_slots")
  displayOrder   Int                      @default(0) @map("display_order")
  createdAt      DateTime                 @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime                 @updatedAt @map("updated_at") @db.Timestamp(6)
  dutyRole       DutyRole                 @relation(fields: [dutyRoleId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  assignments    ScheduleAssignment[]
  nightOverrides DutyWatchNightOverride[]

  @@unique([dutyRoleId, code], map: "duty_position_role_code_unique")
  @@index([dutyRoleId], map: "idx_duty_positions_role")
  @@map("duty_positions")
}

model WeeklySchedule {
  id               String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  dutyRoleId       String                   @map("duty_role_id") @db.Uuid
  weekStartDate    DateTime                 @map("week_start_date") @db.Date // Always a Monday
  status           String                   @default("draft") @db.VarChar(20) // draft, published, active, archived
  createdBy        String?                  @map("created_by") @db.Uuid
  publishedAt      DateTime?                @map("published_at") @db.Timestamp(6)
  publishedBy      String?                  @map("published_by") @db.Uuid
  notes            String?
  createdAt        DateTime                 @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime                 @updatedAt @map("updated_at") @db.Timestamp(6)
  dutyRole         DutyRole                 @relation(fields: [dutyRoleId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  createdByAdmin   AdminUser?               @relation("ScheduleCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull, onUpdate: NoAction)
  publishedByAdmin AdminUser?               @relation("SchedulePublishedBy", fields: [publishedBy], references: [id], onDelete: SetNull, onUpdate: NoAction)
  assignments      ScheduleAssignment[]
  nightOverrides   DutyWatchNightOverride[]

  @@unique([dutyRoleId, weekStartDate], map: "weekly_schedule_role_week_unique")
  @@index([dutyRoleId], map: "idx_weekly_schedules_role")
  @@index([weekStartDate], map: "idx_weekly_schedules_week")
  @@index([status], map: "idx_weekly_schedules_status")
  @@map("weekly_schedules")
}

model ScheduleAssignment {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  scheduleId     String         @map("schedule_id") @db.Uuid
  dutyPositionId String?        @map("duty_position_id") @db.Uuid // null for single-person roles like DDS
  memberId       String         @map("member_id") @db.Uuid
  status         String         @default("assigned") @db.VarChar(20) // assigned, confirmed, released
  confirmedAt    DateTime?      @map("confirmed_at") @db.Timestamp(6)
  releasedAt     DateTime?      @map("released_at") @db.Timestamp(6)
  notes          String?
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamp(6)
  schedule       WeeklySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  dutyPosition   DutyPosition?  @relation(fields: [dutyPositionId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  member         Member         @relation(fields: [memberId], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@index([scheduleId], map: "idx_schedule_assignments_schedule")
  @@index([memberId], map: "idx_schedule_assignments_member")
  @@index([dutyPositionId], map: "idx_schedule_assignments_position")
  @@map("schedule_assignments")
}

model DutyWatchNightOverride {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  scheduleId     String   @map("schedule_id") @db.Uuid
  nightDate      DateTime @map("night_date") @db.Date
  dutyPositionId String   @map("duty_position_id") @db.Uuid
  overrideType   String   @map("override_type") @db.VarChar(20) // 'replace' | 'add' | 'remove'
  memberId       String?  @map("member_id") @db.Uuid
  baseMemberId   String?  @map("base_member_id") @db.Uuid
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  schedule     WeeklySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  dutyPosition DutyPosition   @relation(fields: [dutyPositionId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  member       Member?        @relation("OverrideMember", fields: [memberId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  baseMember   Member?        @relation("OverrideBaseMember", fields: [baseMemberId], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@unique([scheduleId, nightDate, dutyPositionId, baseMemberId], map: "dw_override_unique")
  @@index([scheduleId], map: "idx_dw_overrides_schedule")
  @@index([nightDate], map: "idx_dw_overrides_night_date")
  @@index([memberId], map: "idx_dw_overrides_member")
  @@map("dw_night_overrides")
}

model LockupStatus {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date            DateTime         @unique @db.Date // Operational date (3am rollover)
  currentHolderId String?          @map("current_holder_id") @db.Uuid
  acquiredAt      DateTime?        @map("acquired_at") @db.Timestamp(6)
  buildingStatus  String           @default("secured") @map("building_status") @db.VarChar(20) // secured, open, locking_up
  securedAt       DateTime?        @map("secured_at") @db.Timestamp(6)
  securedBy       String?          @map("secured_by") @db.Uuid
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime         @updatedAt @map("updated_at") @db.Timestamp(6)
  currentHolder   Member?          @relation("LockupCurrentHolder", fields: [currentHolderId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  securedByMember Member?          @relation("LockupSecuredBy", fields: [securedBy], references: [id], onDelete: SetNull, onUpdate: NoAction)
  transfers       LockupTransfer[]
  execution       LockupExecution?

  @@index([date], map: "idx_lockup_status_date")
  @@index([isActive], map: "idx_lockup_status_active")
  @@index([currentHolderId], map: "idx_lockup_status_holder")
  @@map("lockup_status")
}

model LockupTransfer {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lockupStatusId String       @map("lockup_status_id") @db.Uuid
  fromMemberId   String       @map("from_member_id") @db.Uuid
  toMemberId     String       @map("to_member_id") @db.Uuid
  transferredAt  DateTime     @default(now()) @map("transferred_at") @db.Timestamp(6)
  reason         String       @db.VarChar(50) // manual, dds_handoff, duty_watch_takeover
  notes          String?
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  lockupStatus   LockupStatus @relation(fields: [lockupStatusId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  fromMember     Member       @relation("LockupTransferFrom", fields: [fromMemberId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  toMember       Member       @relation("LockupTransferTo", fields: [toMemberId], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@index([lockupStatusId], map: "idx_lockup_transfers_status")
  @@index([fromMemberId], map: "idx_lockup_transfers_from")
  @@index([toMemberId], map: "idx_lockup_transfers_to")
  @@index([transferredAt(sort: Desc)], map: "idx_lockup_transfers_time")
  @@map("lockup_transfers")
}

model LockupExecution {
  id                 String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lockupStatusId     String       @unique @map("lockup_status_id") @db.Uuid
  executedBy         String       @map("executed_by") @db.Uuid
  executedAt         DateTime     @default(now()) @map("executed_at") @db.Timestamp(6)
  membersCheckedOut  Json         @default("[]") @map("members_checked_out") // Array of {id, name}
  visitorsCheckedOut Json         @default("[]") @map("visitors_checked_out") // Array of {id, name}
  totalCheckedOut    Int          @default(0) @map("total_checked_out")
  notes              String?
  createdAt          DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  lockupStatus       LockupStatus @relation(fields: [lockupStatusId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  executedByMember   Member       @relation(fields: [executedBy], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@index([executedAt(sort: Desc)], map: "idx_lockup_executions_time")
  @@index([executedBy], map: "idx_lockup_executions_by")
  @@map("lockup_executions")
}

model MissedCheckout {
  id                String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId          String     @map("member_id") @db.Uuid
  date              DateTime   @db.Date
  originalCheckinAt DateTime   @map("original_checkin_at") @db.Timestamp(6)
  forcedCheckoutAt  DateTime   @default(now()) @map("forced_checkout_at") @db.Timestamp(6)
  resolvedBy        String     @map("resolved_by") @db.VarChar(30) // lockup_sequence, admin, daily_reset
  resolvedByAdminId String?    @map("resolved_by_admin_id") @db.Uuid
  lockupExecutionId String?    @map("lockup_execution_id") @db.Uuid
  notes             String?
  createdAt         DateTime   @default(now()) @map("created_at") @db.Timestamp(6)
  member            Member     @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  resolvedByAdmin   AdminUser? @relation(fields: [resolvedByAdminId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([memberId], map: "idx_missed_checkouts_member")
  @@index([date], map: "idx_missed_checkouts_date")
  @@index([resolvedBy], map: "idx_missed_checkouts_resolved_by")
  @@map("missed_checkouts")
}

// ============================================================================
// UNIT EVENTS & EVENT DUTY WATCH
// ============================================================================

model UnitEventType {
  id                     String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String      @db.VarChar(100)
  category               String      @db.VarChar(50) // mess_dinner, ceremonial, training, social, exercise, vip_visit, remembrance, administrative, other
  defaultDurationMinutes Int         @default(120) @map("default_duration_minutes")
  requiresDutyWatch      Boolean     @default(false) @map("requires_duty_watch")
  defaultMetadata        Json?       @map("default_metadata")
  displayOrder           Int         @default(0) @map("display_order")
  createdAt              DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt              DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)
  unitEvents             UnitEvent[]

  @@index([category], map: "idx_unit_event_types_category")
  @@map("unit_event_types")
}

model UnitEvent {
  id                String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title             String                    @db.VarChar(200)
  eventTypeId       String?                   @map("event_type_id") @db.Uuid
  eventDate         DateTime                  @map("event_date") @db.Date
  startTime         DateTime?                 @map("start_time") @db.Time(6)
  endTime           DateTime?                 @map("end_time") @db.Time(6)
  location          String?                   @db.VarChar(200)
  description       String?
  organizer         String?                   @db.VarChar(200)
  requiresDutyWatch Boolean                   @default(false) @map("requires_duty_watch")
  status            String                    @default("draft") @db.VarChar(20) // draft, planned, confirmed, in_progress, completed, cancelled, postponed
  metadata          Json?
  notes             String?
  createdBy         String?                   @map("created_by") @db.Uuid
  createdAt         DateTime                  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime                  @updatedAt @map("updated_at") @db.Timestamp(6)
  eventType         UnitEventType?            @relation(fields: [eventTypeId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  dutyPositions     UnitEventDutyPosition[]
  dutyAssignments   UnitEventDutyAssignment[]

  @@index([eventDate], map: "idx_unit_events_date")
  @@index([status], map: "idx_unit_events_status")
  @@index([eventTypeId], map: "idx_unit_events_type")
  @@map("unit_events")
}

model UnitEventDutyPosition {
  id           String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId      String                    @map("event_id") @db.Uuid
  code         String                    @db.VarChar(50)
  name         String                    @db.VarChar(100)
  description  String?
  maxSlots     Int                       @default(1) @map("max_slots")
  isStandard   Boolean                   @default(false) @map("is_standard")
  displayOrder Int                       @default(0) @map("display_order")
  createdAt    DateTime                  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime                  @updatedAt @map("updated_at") @db.Timestamp(6)
  event        UnitEvent                 @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  assignments  UnitEventDutyAssignment[]

  @@unique([eventId, code], map: "unit_event_duty_position_event_code_unique")
  @@index([eventId], map: "idx_unit_event_duty_positions_event")
  @@map("unit_event_duty_positions")
}

model UnitEventDutyAssignment {
  id                  String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId             String                 @map("event_id") @db.Uuid
  eventDutyPositionId String?                @map("event_duty_position_id") @db.Uuid
  memberId            String                 @map("member_id") @db.Uuid
  status              String                 @default("assigned") @db.VarChar(20) // assigned, confirmed, declined, released
  isVolunteer         Boolean                @default(false) @map("is_volunteer")
  confirmedAt         DateTime?              @map("confirmed_at") @db.Timestamp(6)
  releasedAt          DateTime?              @map("released_at") @db.Timestamp(6)
  notes               String?
  createdAt           DateTime               @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime               @updatedAt @map("updated_at") @db.Timestamp(6)
  event               UnitEvent              @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  eventDutyPosition   UnitEventDutyPosition? @relation(fields: [eventDutyPositionId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  member              Member                 @relation(fields: [memberId], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@unique([eventId, memberId, eventDutyPositionId], map: "unit_event_duty_assignment_unique")
  @@index([eventId], map: "idx_unit_event_duty_assignments_event")
  @@index([memberId], map: "idx_unit_event_duty_assignments_member")
  @@map("unit_event_duty_assignments")
}
