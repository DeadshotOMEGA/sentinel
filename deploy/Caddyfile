http://{$WIKI_DOMAIN} {
	reverse_proxy wikijs:3000 {
		header_up Host {host}
		header_up X-Forwarded-Host {host}
		header_up X-Forwarded-Proto {scheme}
	}
}

:80 {
	@healthz path /healthz
	handle @healthz {
		rewrite * /health
		reverse_proxy backend:3000 {
			header_up Host {host}
			header_up X-Forwarded-Host {host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	@api path /api /api/*
	handle @api {
		reverse_proxy backend:3000 {
			header_up Host {host}
			header_up X-Forwarded-Host {host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	@socket path /socket.io*
	handle @socket {
		reverse_proxy backend:3000 {
			header_up Host {host}
			header_up X-Forwarded-Host {host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	handle {
		reverse_proxy frontend:3001 {
			header_up Host {host}
			header_up X-Forwarded-Host {host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
}

http://{$NETBIRD_DOMAIN} {
	# Relay (WebSocket)
	reverse_proxy /relay* netbird-server:80

	# WebSocket proxy
	reverse_proxy /ws-proxy/* netbird-server:80

	# Signal gRPC (h2c for plaintext HTTP/2)
	reverse_proxy /signalexchange.SignalExchange/* h2c://netbird-server:80

	# Management API
	reverse_proxy /api/* netbird-server:80

	# Management gRPC
	reverse_proxy /management.ManagementService/* h2c://netbird-server:80

	# Embedded IdP OAuth2
	reverse_proxy /oauth2/* netbird-server:80

	# Dashboard (catch-all)
	reverse_proxy /* netbird-dashboard:80
}
