name: PR Area Autolabel

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  label-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Apply area labels from changed paths
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: false

      - name: Manage bot:conflict label
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const pull_number = context.payload.pull_request.number

            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms))

            let pr
            for (let i = 0; i < 6; i++) {
              const result = await github.rest.pulls.get({ owner, repo, pull_number })
              pr = result.data
              if (pr.mergeable_state && pr.mergeable_state !== 'unknown') {
                break
              }
              await sleep(2000)
            }

            if (!pr.mergeable_state || pr.mergeable_state === 'unknown') {
              core.info('mergeable_state is still unknown; skipping bot:conflict update.')
              return
            }

            const hasConflict = pr.mergeable_state === 'dirty'
            const labels = (pr.labels || []).map((label) => label.name)
            const hasConflictLabel = labels.includes('bot:conflict')

            if (hasConflict && !hasConflictLabel) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pull_number,
                labels: ['bot:conflict'],
              })
              core.info('Applied bot:conflict')
              return
            }

            if (!hasConflict && hasConflictLabel) {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: pull_number,
                name: 'bot:conflict',
              })
              core.info('Removed bot:conflict')
              return
            }

            core.info(`mergeable_state=${pr.mergeable_state}; no conflict label change needed.`)
