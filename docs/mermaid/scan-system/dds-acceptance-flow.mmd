flowchart TD
    START([DDS Acceptance Triggered]) --> VALIDATE{Member exists<br/>in database?}

    VALIDATE -->|No| ERR_404[/Throw NotFoundError/]

    VALIDATE -->|Yes| CHECK_EXISTING{Existing DDS<br/>assignment today?}

    %% ─── NO EXISTING ASSIGNMENT ───
    CHECK_EXISTING -->|None exists| CREATE_NEW[Create new dds_assignment<br/>status = 'active'<br/>acceptedAt = now]
    CREATE_NEW --> AUDIT_LOG

    %% ─── PENDING FOR THIS MEMBER ───
    CHECK_EXISTING -->|Pending, same member| ACTIVATE[Update dds_assignment<br/>status = 'active'<br/>acceptedAt = now]
    ACTIVATE --> AUDIT_LOG

    %% ─── ALREADY ACTIVE ───
    CHECK_EXISTING -->|Active| ERR_CONFLICT_ACTIVE[/Throw ConflictError<br/>'DDS already accepted today'/]

    %% ─── PENDING FOR DIFFERENT MEMBER ───
    CHECK_EXISTING -->|Pending, different member| ERR_CONFLICT_OTHER[/Throw ConflictError<br/>'DDS already assigned today'/]

    %% ─── POST-ASSIGNMENT ───
    AUDIT_LOG[(Write to<br/>responsibility_audit_log<br/>action = 'self_accepted')] --> LOCKUP_CHECK{Current lockup<br/>status?}

    LOCKUP_CHECK -->|Someone else holds it| TRANSFER[Transfer lockup to DDS<br/>reason = 'dds_handoff']
    LOCKUP_CHECK -->|Nobody holds it| ACQUIRE[DDS acquires lockup<br/>directly]

    TRANSFER --> LOCKUP_OK{Lockup operation<br/>succeeded?}
    ACQUIRE --> LOCKUP_OK

    LOCKUP_OK -->|Yes| WS_DDS[/Broadcast dds:update<br/>action = 'accepted'/]
    LOCKUP_OK -->|No| LOG_ERR[Log error<br/>DDS acceptance still succeeds]
    LOG_ERR --> WS_DDS

    WS_DDS --> DONE([DDS Acceptance Complete])

    %% ─── LINKS ───
    click LOCKUP_CHECK "lockup-eligibility.svg" _blank
    click WS_DDS "websocket-events.svg" _blank

    %% ─── STYLES ───
    classDef error fill:#fee,stroke:#c00,color:#900
    classDef success fill:#efe,stroke:#0a0,color:#060
    classDef ws fill:#eef,stroke:#00c,color:#006
    classDef db fill:#fef,stroke:#a0a,color:#606
    classDef warn fill:#ffd,stroke:#aa0,color:#660

    class ERR_404,ERR_CONFLICT_ACTIVE,ERR_CONFLICT_OTHER error
    class DONE success
    class WS_DDS ws
    class AUDIT_LOG db
    class LOG_ERR warn
