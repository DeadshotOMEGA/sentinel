flowchart TD
    START{Sign-out method?}

    %% ─── BADGE SCAN AT KIOSK ───
    START -->|Badge scanned at kiosk| LOOKUP_BADGE[Lookup badge<br/>by serial number]
    LOOKUP_BADGE --> IS_TEMP{Badge<br/>assignmentType?}

    IS_TEMP -->|member| MEMBER_FLOW([Route to Member<br/>Check-in/out Flow])
    IS_TEMP -->|temporary| FIND_VISITOR{Active visitor<br/>with this badge?<br/>checkOutTime IS NULL}

    FIND_VISITOR -->|No| ERR_NO_VISITOR[Return 404<br/>No active visitor<br/>for this badge]
    FIND_VISITOR -->|Yes| CHECKOUT

    %% ─── ADMIN MANUAL ───
    START -->|Admin panel| SELECT_VISITOR[Admin selects active visitor<br/>from presence list]
    SELECT_VISITOR --> CHECKOUT

    %% ─── CHECKOUT PROCESS ───
    CHECKOUT --> UPDATE_VISITOR[(UPDATE visitors table<br/>checkOutTime = now)]

    UPDATE_VISITOR --> HAD_BADGE{Visitor had<br/>temporary badge?}

    HAD_BADGE -->|Yes| RELEASE_BADGE[(UPDATE badges table<br/>assignedToId = NULL<br/>status = 'active')]
    HAD_BADGE -->|No| BROADCAST

    RELEASE_BADGE --> BROADCAST

    %% ─── REAL-TIME UPDATES ───
    BROADCAST --> WS_VISITOR[/Broadcast visitor:signout<br/>via WebSocket/]
    WS_VISITOR --> WS_PRESENCE[/Broadcast presence:update<br/>via WebSocket/]
    WS_PRESENCE --> DONE([Visitor Sign-out Complete])

    %% ─── STYLES ───
    classDef error fill:#fee,stroke:#c00,color:#900
    classDef success fill:#efe,stroke:#0a0,color:#060
    classDef ws fill:#eef,stroke:#00c,color:#006
    classDef db fill:#fef,stroke:#a0a,color:#606
    classDef subprocess fill:#ffe,stroke:#aa0,color:#660

    class ERR_NO_VISITOR error
    class DONE success
    class WS_VISITOR,WS_PRESENCE ws
    class UPDATE_VISITOR,RELEASE_BADGE db
    class MEMBER_FLOW subprocess
