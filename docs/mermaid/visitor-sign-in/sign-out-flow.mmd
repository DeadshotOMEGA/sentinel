flowchart TD
    START{Sign-out method?}

    %% ─── BADGE SCAN AT KIOSK ───
    START -->|Badge scanned at kiosk| FROM_ROUTER[Routed from Badge Scan Router<br/>Active visitor confirmed]
    FROM_ROUTER --> CHECKOUT

    %% ─── ADMIN MANUAL ───
    START -->|Admin panel| SELECT_VISITOR[Admin selects active visitor<br/>from presence list]
    SELECT_VISITOR --> CHECKOUT

    %% ─── CHECKOUT PROCESS ───
    CHECKOUT --> UPDATE_VISITOR[(UPDATE visitors table<br/>checkOutTime = now<br/>checkOutMethod = kiosk_scan | admin_manual)]

    UPDATE_VISITOR --> HAD_BADGE{Visitor had<br/>temporary badge?}

    HAD_BADGE -->|Yes| RELEASE_BADGE[(UPDATE badges table<br/>assignedToId = NULL<br/>lastUsed = now<br/>status = 'active')]
    HAD_BADGE -->|No| BROADCAST

    RELEASE_BADGE --> WS_BADGE_RELEASE[/Broadcast visitor:badgeReleased<br/>via WebSocket/]
    WS_BADGE_RELEASE --> BROADCAST

    %% ─── REAL-TIME UPDATES ───
    BROADCAST --> WS_VISITOR[/Broadcast visitor:signout<br/>via WebSocket/]
    WS_VISITOR --> WS_PRESENCE[/Broadcast presence:update<br/>via WebSocket/]
    WS_PRESENCE --> DONE([Visitor Sign-out Complete])

    %% ─── LINKS ───
    click FROM_ROUTER "../badge-scan-router.svg" _blank
    click WS_VISITOR "../websocket-events.svg" _blank

    %% ─── STYLES ───
    classDef success fill:#efe,stroke:#0a0,color:#060
    classDef ws fill:#eef,stroke:#00c,color:#006
    classDef db fill:#fef,stroke:#a0a,color:#606
    classDef subprocess fill:#ffe,stroke:#aa0,color:#660

    class DONE success
    class WS_VISITOR,WS_PRESENCE,WS_BADGE_RELEASE ws
    class UPDATE_VISITOR,RELEASE_BADGE db
    class FROM_ROUTER subprocess
